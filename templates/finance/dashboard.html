{% extends 'base/base.html' %}
{% load humanize %}

{% block title %}Comptabilité — {{ request.user.shop.name }}{% endblock %}

{% block content %}
<div class="space-y-6">

    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
            <h2 class="text-2xl font-bold text-gray-900">Comptabilité</h2>
            <p class="text-sm text-gray-500">Tableau de bord financier — Vue d'ensemble</p>
        </div>

        <div class="flex items-center gap-3">
            {% if is_pro %}
            <a href="{% url 'export_accounting_pdf' %}" class="inline-flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded shadow">
                <i class="fas fa-file-download"></i>
                <span>Exporter PDF</span>
            </a>
            {% else %}
            <a href="{% url 'plans' %}" class="inline-flex items-center gap-2 px-4 py-2 bg-gray-100 text-gray-700 rounded border">
                <i class="fas fa-lock"></i>
                <span>Passer à Pro</span>
            </a>
            {% endif %}
        </div>
    </div>

    <!-- KPI cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="bg-white rounded-lg shadow p-4 flex items-center justify-between">
            <div>
                <div class="text-xs text-muted">Chiffre d'affaires</div>
                <div class="text-xl font-bold text-primary">{{ total_sales|intcomma }} FCFA</div>
            </div>
            <div class="flex items-center gap-3">
                <span class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-primary/10 text-primary">
                    <i class="fas fa-wallet"></i>
                </span>
                <div class="text-sm text-secondary font-semibold">+{{ sales_change|default:'0' }}%</div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-4 flex items-center justify-between">
            <div>
                <div class="text-xs text-muted">Marge brute</div>
                <div class="text-xl font-bold text-accent">{{ gross_profit|intcomma }} FCFA</div>
            </div>
            <div class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-accent/10 text-accent">
                <i class="fas fa-percentage"></i>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-4 flex items-center justify-between">
            <div>
                <div class="text-xs text-muted">Dépenses</div>
                <div class="text-xl font-bold text-red-600">{{ total_expenses|intcomma }} FCFA</div>
            </div>
            <div class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-red-100 text-red-600">
                <i class="fas fa-file-invoice-dollar"></i>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-4 flex items-center justify-between">
            <div>
                <div class="text-xs text-muted">Résultat net</div>
                <div class="text-xl font-bold {% if profit >= 0 %}text-primary{% else %}text-red-600{% endif %}">{{ profit|intcomma }} FCFA</div>
            </div>
            <div class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-primary/10 text-primary">
                <i class="fas fa-chart-line"></i>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Main chart and P&L -->
        <div class="lg:col-span-2 bg-white rounded-lg shadow p-4">
            <h3 class="text-lg font-semibold text-gray-800">Tendance des ventes (30 jours)</h3>
            <div class="mt-3 h-64">
                <canvas id="sales-trend" class="w-full h-full"></canvas>
            </div>

            <div class="mt-6">
                <h4 class="text-sm font-medium text-gray-700">Compte de résultat simplifié</h4>
                <div class="mt-2 grid grid-cols-2 gap-2 text-sm text-gray-700">
                    <div>Chiffre d'affaires</div><div class="text-right font-semibold">{{ total_sales|intcomma }} FCFA</div>
                    <div class="text-gray-600">COGS</div><div class="text-right">{{ cogs|intcomma }} FCFA</div>
                    <div class="font-bold text-yellow-800">Marge Brute</div><div class="text-right font-bold">{{ gross_profit|intcomma }} FCFA</div>
                    <div class="text-gray-600">Dépenses</div><div class="text-right text-red-600">{{ total_expenses|intcomma }} FCFA</div>
                    <div class="font-bold">Résultat Net</div><div class="text-right font-bold {% if profit >= 0 %}text-blue-600{% else %}text-red-600{% endif %}">{{ profit|intcomma }} FCFA</div>
                </div>
            </div>
        </div>

        <!-- Right column: Expenses breakdown & actions -->
        <div class="bg-white rounded-lg shadow p-4">
            <h3 class="text-lg font-semibold text-gray-800">Dépenses par catégorie</h3>
            <ul class="mt-3 divide-y divide-gray-100">
                {% for exp in expense_breakdown %}
                <li class="py-2 flex justify-between items-center">
                    <div class="text-sm text-gray-800">{{ exp.category }}</div>
                    <div class="text-sm font-semibold text-red-600">{{ exp.total|intcomma }} FCFA</div>
                </li>
                {% empty %}
                <li class="py-2 text-sm text-gray-500 italic">Aucune dépense enregistrée.</li>
                {% endfor %}
            </ul>

            <div class="mt-4">
                <a href="{% url 'expense_list' %}" class="block w-full text-center px-4 py-2 bg-indigo-600 text-white rounded">Gérer les dépenses</a>
            </div>
        </div>
    </div>

</div>

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Chart colors (keep in sync with Tailwind config in base_public)
const PRIMARY_COLOR = '#4F46E5';
const PRIMARY_ALPHA = 'rgba(79,70,229,0.12)';
const SECONDARY_COLOR = '#10B981';
const MUTED_COLOR = '#6B7280';

;(function(){
    const el = document.getElementById('sales-trend');
    if (!el) return;
    const ctx = el.getContext('2d');
    const labels = {{ dates|default:"[]"|safe }};
    const dataVals = {{ totals|default:"[]"|safe }};

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Revenu',
                data: dataVals,
                borderColor: PRIMARY_COLOR,
                backgroundColor: PRIMARY_ALPHA,
                pointBackgroundColor: SECONDARY_COLOR,
                tension: 0.35,
                borderWidth: 2,
                fill: true,
                pointRadius: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                x: { grid: { color: 'rgba(0,0,0,0.04)' }, ticks: { color: MUTED_COLOR } },
                y: { grid: { color: 'rgba(0,0,0,0.04)' }, ticks: { color: MUTED_COLOR } }
            }
        }
    });
})();
</script>
{% endblock %}

{% endblock %}