{% extends 'base/base.html' %}

{% block title %}Point de Vente - ShopManager{% endblock %}

{% block content %}
<div class="h-auto md:h-[calc(100vh-6rem)] flex flex-col md:flex-row gap-4 pb-20 md:pb-0">

    <!-- Left: Product List -->
    <div class="w-full md:w-2/3 flex flex-col bg-white rounded-lg shadow overflow-hidden">
        <!-- Search Bar -->
        <div class="p-4 border-b border-gray-200">
            <input type="text" name="q"
                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary"
                placeholder="Scanner ou rechercher un produit..." hx-get="{% url 'product_search' %}"
                hx-trigger="keyup changed delay:200ms" hx-target="#product-results" autofocus>
        </div>

        <!-- Product Grid -->
        <div id="product-results" class="flex-1 overflow-y-auto p-4 bg-gray-50">
            {% include 'sales/partials/product_results.html' %}
        </div>
    </div>

    <!-- Right: Cart & Actions -->
    <div class="w-full md:w-1/3 flex flex-col bg-white rounded-lg shadow h-full">
        <div class="p-4 bg-gray-800 text-white flex justify-between items-center rounded-t-lg">
            <h3 class="font-bold text-lg">Panier en cours</h3>
            <span class="text-sm bg-gray-700 px-2 py-1 rounded" id="cart-count">0 articles</span>
        </div>

        <div class="flex-1 overflow-y-auto p-4 space-y-2" id="cart-items">
            <p class="text-gray-500 text-center mt-10 empty-cart-msg">Le panier est vide.</p>
        </div>

        <!-- Custom Item Form -->
        <div class="p-4 bg-gray-50 border-t border-gray-200">
            <h4 class="text-sm font-semibold text-gray-700 mb-2">Ajout rapide (Vente libre)</h4>
            <div class="flex gap-2 mb-2">
                <input type="text" id="custom-name" placeholder="Article"
                    class="flex-1 text-sm border-gray-300 rounded focus:ring-primary focus:border-primary">
                <input type="number" id="custom-price" placeholder="Prix"
                    class="w-20 text-sm border-gray-300 rounded focus:ring-primary focus:border-primary">
            </div>
            <button onclick="addCustomItem()"
                class="w-full py-1 bg-indigo-100 text-indigo-700 rounded text-sm font-bold hover:bg-indigo-200">
                + Ajouter Article Manuel
            </button>
        </div>

        <!-- Totals & Calculator -->
        <div class="p-4 border-t border-gray-200 bg-gray-50">
            <div class="flex justify-between items-center mb-2">
                <span class="text-gray-600">Total à payer</span>
                <span class="font-bold text-xl text-gray-800" id="cart-total">0 FCFA</span>
            </div>

            <div class="mb-4">
                <label class="text-xs font-semibold text-gray-500 uppercase">Mode de Paiement</label>
                <select id="payment-method"
                    class="w-full text-sm border-gray-300 rounded focus:ring-primary focus:border-primary p-2">
                    <option value="CASH" selected>Espèces</option>
                    <option value="MOMO">Mobile Money</option>
                    <option value="BANK">Virement Bancaire</option>
                    <option value="CARD">Carte Bancaire</option>
                </select>
            </div>

            <div class="mb-4">
                <label class="text-xs font-semibold text-gray-500 uppercase">Montant perçu</label>
                <input type="number" id="amount-paid"
                    class="w-full text-lg font-bold border-gray-300 rounded focus:ring-primary focus:border-primary"
                    placeholder="0" oninput="calculateChange()">
                <div class="flex justify-between items-center mt-1">
                    <span class="text-sm text-gray-600">Monnaie à rendre :</span>
                    <span class="font-bold text-lg text-emerald-600" id="change-due">0 FCFA</span>
                </div>
            </div>

            <button onclick="processSale()"
                class="w-full py-3 bg-secondary hover:bg-emerald-600 text-white font-bold rounded-lg shadow text-lg flex justify-center items-center">
                <span>Encaisser</span>
            </button>
        </div>
    </div>
</div>

<script>
    let cart = [];

    function addToCart(id, name, price, maxQuantity) {
        const existingItem = cart.find(item => item.id === id);

        if (existingItem) {
            if (existingItem.quantity + 1 > maxQuantity) {
                alert(`Stock insuffisant ! Max: ${maxQuantity}`);
                return;
            }
            existingItem.quantity++;
        } else {
            if (1 > maxQuantity) {
                alert(`Stock insuffisant ! Max: ${maxQuantity}`);
                return;
            }
            cart.push({ id: id, name: name, price: parseFloat(price), quantity: 1 });
        }
        updateCartUI();
    }

    function addCustomItem() {
        const name = document.getElementById('custom-name').value;
        const price = parseFloat(document.getElementById('custom-price').value);

        if (!name || isNaN(price)) {
            alert("Veuillez entrer un nom et un prix valide.");
            return;
        }

        cart.push({ id: null, name: name, price: price, quantity: 1 });
        updateCartUI();
        document.getElementById('custom-name').value = '';
        document.getElementById('custom-price').value = '';
    }

    function removeFromCart(index) {
        cart.splice(index, 1);
        updateCartUI();
    }

    function updateCartUI() {
        const cartItemsContainer = document.getElementById('cart-items');
        const cartCount = document.getElementById('cart-count');
        const cartTotal = document.getElementById('cart-total');

        cartItemsContainer.innerHTML = '';
        let total = 0;
        let count = 0;

        if (cart.length === 0) {
            cartItemsContainer.innerHTML = '<p class="text-gray-500 text-center mt-10 empty-cart-msg">Le panier est vide.</p>';
        } else {
            cart.forEach((item, index) => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                count += item.quantity;

                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex justify-between items-center p-2 bg-gray-50 rounded border border-gray-100 text-sm';
                itemDiv.innerHTML = `
                    <div class="flex-1">
                        <div class="font-medium text-gray-800">${item.name}</div>
                        <div class="text-xs text-gray-500">${item.quantity} x ${item.price} = ${itemTotal}</div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="changeQuantity(${index}, -1)" class="w-6 h-6 rounded bg-gray-200 text-gray-600 hover:bg-gray-300 flex items-center justify-center">-</button>
                        <button onclick="changeQuantity(${index}, 1)" class="w-6 h-6 rounded bg-gray-200 text-gray-600 hover:bg-gray-300 flex items-center justify-center">+</button>
                        <button onclick="removeFromCart(${index})" class="text-red-500 hover:text-red-700 ml-1"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                cartItemsContainer.appendChild(itemDiv);
            });
        }

        cartCount.textContent = `${count} articles`;
        cartTotal.textContent = `${total} FCFA`;
        calculateChange();
    }

    function changeQuantity(index, delta) {
        const item = cart[index];
        if (item.quantity + delta > 0) {
            // Basic Check (Improved check would need to know max stock for this specific item again, simplified here)
            item.quantity += delta;
        } else {
            // If quantity becomes 0, remove? or just stay 1? User usually deletes.
            // Let's allow staying at 1 minimum via buttons, delete via trash.
            if (delta < 0) return;
        }
        updateCartUI();
    }

    function calculateChange() {
        let total = 0;
        cart.forEach(item => {
            total += item.price * item.quantity;
        });
        const paid = parseFloat(document.getElementById('amount-paid').value) || 0;
        const change = paid - total;
        document.getElementById('change-due').textContent = (Math.max(0, change)) + ' FCFA';
    }


    function processSale() {
        if (cart.length === 0) {
            alert("Panier vide !");
            return;
        }

        if (!confirm("Confirmer la vente ?")) return;

        const paymentMethod = document.getElementById('payment-method').value;

        const payload = {
            payment_method: paymentMethod,
            items: cart.map(item => ({
                product: item.id,
                product_name: item.name, // Always send name, even for products
                quantity: item.quantity,
                price: item.price
            }))
        };


        fetch('/api/sales/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(payload)
        })
            .then(async res => {
                if (!res.ok) {
                    const errorData = await res.json();
                    // Try to show specific error from serializer (e.g. Stock Check)
                    let msg = 'Erreur vente';
                    if (errorData && errorData.items && Array.isArray(errorData.items)) {
                        // DRF often returns array of errors per item or string for overall
                        msg = "Erreur validation articles";
                        // Try to extract first string
                    } else if (errorData && Array.isArray(errorData)) {
                        msg = errorData[0];
                    }
                    // Stock error usually comes as non_field_errors or specific field? 
                    // My serializer raises validaton error on 'items' or general.
                    // Let's just show JSON string if possible or generic.
                    console.error(errorData);
                    throw new Error(JSON.stringify(errorData) || 'Erreur inconnue');
                }
                return res.json();
            })
            .then(() => {
                alert("Vente enregistrée avec succès !");
                cart = [];
                document.getElementById('amount-paid').value = '';
                document.getElementById('custom-name').value = '';
                document.getElementById('custom-price').value = '';
                updateCartUI();
            })
            .catch(err => {
                // Clean up error message for display
                let msg = err.message;
                if (msg.includes("Stock insuffisant")) {
                    msg = "Stock insuffisant ! " + msg; // Basic hack, improve later
                }
                alert("Échec : " + msg);
            });
    }
</script>
{% endblock %}